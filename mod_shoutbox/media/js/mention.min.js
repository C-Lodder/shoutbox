/*
 * Copyright (c) 2013 Jacob Kelley 
 * https://github.com/jakiestfu/Mention.js
 *
 * Modified by JoomJunk
*/

!function(e){e.fn.extend({mention:function(t){this.opts={users:[],delimiter:"@",sensitive:!0,emptyQuery:!1,queryBy:["name","username"],typeaheadOpts:{}};var r=e.extend({},this.opts,t),n=function(e,t){var n;for(n=t;n>=0&&e[n]!=r.delimiter;n--);return e.substring(n,t)},i=function(e){var t;if(r.emptyQuery){var n=this.query.toLowerCase(),i=this.$element[0].selectionStart,s=n.slice(i-1,i);if(s==r.delimiter)return!0}for(t in r.queryBy)if(e[r.queryBy[t]]){var a,u=e[r.queryBy[t]].toLowerCase(),o=this.query.toLowerCase().match(new RegExp(r.delimiter+"\\w+","g"));if(o)for(a=0;a<o.length;a++){var h=o[a].substring(1).toLowerCase(),m=new RegExp(r.delimiter+u,"g"),l=this.query.toLowerCase().match(m);if(-1!=u.indexOf(h)&&null===l)return!0}}},s=function(e){var t,n=this.query,i=this.$element[0].selectionStart;for(t=i;t>=0&&n[t]!=r.delimiter;t--);var s=(n.substring(t,i),n.substring(0,t)),a=n.substring(i),n=s+r.delimiter+e+a;return this.tempQuery=n,n},a=function(e){if(e.length&&r.sensitive){var t,i=n(this.query,this.$element[0].selectionStart).substring(1),s=e.length,a={highest:[],high:[],med:[],low:[]},u=[];if(1==i.length){for(t=0;s>t;t++){var o=e[t];o.username[0]==i?a.highest.push(o):o.username[0].toLowerCase()==i.toLowerCase()?a.high.push(o):-1!=o.username.indexOf(i)?a.med.push(o):a.low.push(o)}for(t in a){var h;for(h in a[t])u.push(a[t][h])}return u}}return e},u=function(t){var n=this;return t=e(t).map(function(t,i){t=e(n.options.item).attr("data-value",i.username);var s=e("<div />");return i.image&&s.append('<img class="mention_image" src="'+i.image+'">'),i.name&&s.append('<b class="mention_name">'+i.name+"</b>"),i.username&&s.append('<span class="mention_username"> '+r.delimiter+i.username+"</span>"),t.find("a").html(n.highlighter(s.html())),t[0]}),t.first().addClass("active"),this.$menu.html(t),this};return e.fn.typeahead.Constructor.prototype.render=u,this.each(function(){var t=e(this);t.typeahead(e.extend({source:r.users,matcher:i,updater:s,sorter:a},r.typeaheadOpts))})}})}(jQuery);